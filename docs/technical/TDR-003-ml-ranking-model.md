# TDR-003: ML-модель ранжирования рекомендаций

## Metadata

| Поле | Значение |
|------|----------|
| **Статус** | Draft |
| **Дата** | 2025-12-03 |
| **Приоритет** | Low |
| **Оценка** | 6-8 часов |

---

## 1. Проблема

Сейчас ранжирование использует статическую формулу с хардкодными весами:

```
final_score = semantic_similarity + copurchase_boost - category_penalty
```

Проблемы:
- Веса подобраны вручную, не оптимальны
- Не учитывает все доступные сигналы
- Не адаптируется к поведению пользователей

---

## 2. Решение

Заменить статическую формулу на ML-модель (LightGBM/CatBoost), которая:
- Обучается на данных о кликах и добавлениях в корзину
- Автоматически подбирает веса признаков
- Предсказывает вероятность взаимодействия с товаром

---

## 3. Признаки модели

| Признак | Описание |
|---------|----------|
| `semantic_similarity` | Косинусное сходство эмбеддингов |
| `copurchase_count` | Сколько раз покупали вместе |
| `same_category` | Та же категория (0/1) |
| `same_root_category` | Та же root-категория (0/1) |
| `complementary_score` | Скор комплементарности категорий |
| `price_ratio` | Отношение цен товаров |
| `has_discount` | Есть скидка (0/1) |
| `discount_percent` | Процент скидки |
| `product_popularity` | Популярность товара (просмотры/покупки) |
| `product_rating` | Средний рейтинг товара |
| `feedback_ratio` | Отношение thumbs_up к thumbs_down |

---

## 4. Обучающие данные

**Позитивные примеры (label=1):**
- Клик на рекомендацию
- Добавление рекомендованного товара в корзину
- Thumbs up на рекомендацию

**Негативные примеры (label=0):**
- Показанная, но не кликнутая рекомендация
- Thumbs down на рекомендацию

---

## 5. Архитектура

```
Показ рекомендаций → Логирование событий → Таблица recommendation_events
                                                    ↓
                                           Периодическое обучение
                                                    ↓
                                           LightGBM модель
                                                    ↓
                                           Предсказание скоров
```

---

## 6. План реализации

1. **Логирование событий** — таблица `recommendation_events` (показ, клик, корзина)
2. **Сбор данных** — накопить 1000+ событий
3. **Скрипт обучения** — `train_ranking_model.py`
4. **Интеграция** — использовать `model.predict()` вместо статической формулы
5. **A/B тест** — сравнить старый и новый алгоритм

---

## 7. Зависимости

- TDR-002 (комплементарные категории) — `complementary_score` как признак
- Достаточно данных о взаимодействиях (минимум 1000 событий)

---

## 8. Метрики успеха

- CTR на рекомендации выше на 10%+
- Конверсия в корзину выше на 5%+
- NDCG@10 > 0.7
