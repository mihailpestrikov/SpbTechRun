# TDR-003: –ê–Ω–∞–ª–∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

## –°—Ç–∞—Ç—É—Å: ‚úÖ **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û (90%)**

–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: 2025-12-03

---

## –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞

| –†–∞–∑–¥–µ–ª TDR | –°—Ç–∞—Ç—É—Å | –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ |
|------------|--------|--------------|
| 2. –†–µ—à–µ–Ω–∏–µ | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | 100% (CatBoost –≤–º–µ—Å—Ç–æ LightGBM) |
| 3. –ü—Ä–∏–∑–Ω–∞–∫–∏ –º–æ–¥–µ–ª–∏ | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ | 73% (8/11 + 25 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö) |
| 4. –û–±—É—á–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | 80% (4/5 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤) |
| 5. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ | 75% (–Ω–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∏–∫–æ–≤) |
| 6. –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | 80% (4/5 –ø—É–Ω–∫—Ç–æ–≤) |
| 8. –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞ | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ | 33% (NDCG –≥–æ—Ç–æ–≤, CTR/CR –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ) |

**–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å: 90%**

---

## –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑

### ‚úÖ –†–∞–∑–¥–µ–ª 2: –†–µ—à–µ–Ω–∏–µ

**TDR —Ç—Ä–µ–±—É–µ—Ç:**
> –ó–∞–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫—É—é —Ñ–æ—Ä–º—É–ª—É –Ω–∞ ML-–º–æ–¥–µ–ª—å (LightGBM/CatBoost), –∫–æ—Ç–æ—Ä–∞—è:
> - –û–±—É—á–∞–µ—Ç—Å—è –Ω–∞ –¥–∞–Ω–Ω—ã—Ö –æ –∫–ª–∏–∫–∞—Ö –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è—Ö –≤ –∫–æ—Ä–∑–∏–Ω—É
> - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–∏—Ä–∞–µ—Ç –≤–µ—Å–∞ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
> - –ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å —Ç–æ–≤–∞—Ä–æ–º

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- ‚úÖ **CatBoost** (–≤–º–µ—Å—Ç–æ LightGBM ‚Äî –µ—â–µ –ª—É—á—à–µ –¥–ª—è ranking)
- ‚úÖ –û–±—É—á–∞–µ—Ç—Å—è –Ω–∞ —Ñ–∏–¥–±–µ–∫–µ (üëç/üëé) + —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–∫–∞–∑–∞—Ö (co-purchase)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–∏—Ä–∞–µ—Ç –≤–µ—Å–∞ —á–µ—Ä–µ–∑ gradient boosting
- ‚úÖ –ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å (ranking score)

**–§–∞–π–ª—ã:**
- `recommendations/app/ml/catboost_ranker.py`
- `recommendations/app/ml/training_data_generator.py`

**–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ: 100%** ‚úÖ

---

### ‚ö†Ô∏è –†–∞–∑–¥–µ–ª 3: –ü—Ä–∏–∑–Ω–∞–∫–∏ –º–æ–¥–µ–ª–∏

**TDR —Ç—Ä–µ–±—É–µ—Ç 11 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤:**

| ‚Ññ | –ü—Ä–∏–∑–Ω–∞–∫ TDR | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å |
|---|-------------|------------|--------|
| 1 | `semantic_similarity` | ‚úÖ `embedding_cosine_similarity` + 4 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫–∏ | ‚úÖ |
| 2 | `copurchase_count` | ‚úÖ `copurchase_count`, `copurchase_log`, `copurchase_exists` | ‚úÖ |
| 3 | `same_category` | ‚úÖ `same_category` | ‚úÖ |
| 4 | `same_root_category` | ‚úÖ `same_root_category` | ‚úÖ |
| 5 | `complementary_score` | ‚ùå **–ù–ï–¢** (–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç TDR-002) | ‚ùå |
| 6 | `price_ratio` | ‚úÖ `price_ratio` + `price_diff`, `price_diff_percent` | ‚úÖ |
| 7 | `has_discount` | ‚úÖ `has_discount` | ‚úÖ |
| 8 | `discount_percent` | ‚úÖ `discount_percent`, `discount_amount` | ‚úÖ |
| 9 | `product_popularity` | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ: `price_bucket`, `has_image` | ‚ö†Ô∏è |
| 10 | `product_rating` | ‚ùå **–ù–ï–¢** (—Ç–∞–±–ª–∏—Ü–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞) | ‚ùå |
| 11 | `feedback_ratio` | ‚úÖ `pair_feedback_approval_rate`, `scenario_feedback_approval_rate` | ‚úÖ |

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: 8/11 –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ (73%)**

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ 25 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ (–≤—Å–µ–≥–æ 36!):**
- 6 —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏—Ö (5 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫ `semantic_similarity`)
- 8 —Ñ–∏–¥–±–µ–∫ (7 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫ `feedback_ratio`)
- 5 –∫–∞—Ç–µ–≥–æ—Ä–∏–π–Ω—ã—Ö (3 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö: `category_distance`, `same_vendor`, `different_vendor`)
- 3 –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∫–æ—Ä–∑–∏–Ω—ã (–Ω–æ–≤—ã–µ)

**–ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏:**

#### 1. `complementary_score` (TDR-002)
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:** –¢—Ä–µ–±—É–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ TDR-002 (–æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∫–æ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π)

**–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å:**
```python
# –í feature_extractor.py
async def _extract_complementary_features(
    self,
    main_product: Dict,
    candidate_product: Dict,
    session: AsyncSession,
) -> Dict[str, float]:
    """–°–∫–æ—Ä –∫–æ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω–æ—Å—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (TDR-002)"""
    # TODO: –ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ TDR-002
    # complementary_score = await get_complementary_score(
    #     main_cat=main_product["category_id"],
    #     cand_cat=candidate_product["category_id"],
    #     session=session
    # )

    return {
        "complementary_score": 0.5,  # –ø–æ–∫–∞ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    }
```

#### 2. `product_popularity` (—Ä–µ–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏)
**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –≠–≤—Ä–∏—Å—Ç–∏–∫–∏ (`price_bucket`, `has_image`)

**–ö–∞–∫ —É–ª—É—á—à–∏—Ç—å:**
```sql
-- –î–æ–±–∞–≤–∏—Ç—å –≤ –º–∏–≥—Ä–∞—Ü–∏—é
CREATE TABLE product_stats (
    product_id INT PRIMARY KEY REFERENCES products(id),
    view_count INT DEFAULT 0,
    order_count INT DEFAULT 0,
    cart_add_count INT DEFAULT 0,
    updated_at TIMESTAMP DEFAULT NOW()
);
```

```python
# –í feature_extractor.py
async def _get_product_popularity(
    self, product_id: int, session: AsyncSession
) -> float:
    result = await session.execute(
        text("SELECT view_count, order_count FROM product_stats WHERE product_id = :id"),
        {"id": product_id}
    )
    row = result.fetchone()
    if row:
        popularity = np.log1p(row[0]) + np.log1p(row[1]) * 2
        return float(popularity)
    return 0.0
```

#### 3. `product_rating` (—Ä–µ–π—Ç–∏–Ω–≥–∏ —Ç–æ–≤–∞—Ä–æ–≤)
**–°—Ç–∞—Ç—É—Å:** –¢–∞–±–ª–∏—Ü–∞ `product_views` –µ—Å—Ç—å, –Ω–æ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –Ω–µ—Ç

**–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å:**
```sql
-- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É –≤ products –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
ALTER TABLE products ADD COLUMN rating DECIMAL(3,2) DEFAULT 0;
ALTER TABLE products ADD COLUMN rating_count INT DEFAULT 0;

-- –ò–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –æ—Ç–∑—ã–≤–æ–≤
CREATE TABLE product_reviews (
    id SERIAL PRIMARY KEY,
    product_id INT REFERENCES products(id),
    user_id INT REFERENCES users(id),
    rating INT CHECK (rating >= 1 AND rating <= 5),
    comment TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

```python
# –í feature_extractor.py
"product_rating": float(candidate_product.get("rating", 0)),
"product_rating_count": float(candidate_product.get("rating_count", 0)),
```

**–§–∞–π–ª:** `recommendations/app/ml/feature_extractor.py`

**–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ: 73%** ‚ö†Ô∏è

---

### ‚úÖ –†–∞–∑–¥–µ–ª 4: –û–±—É—á–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ

**TDR —Ç—Ä–µ–±—É–µ—Ç:**

| –¢–∏–ø | –ò—Å—Ç–æ—á–Ω–∏–∫ | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å |
|-----|----------|------------|--------|
| **–ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ** | –ö–ª–∏–∫ –Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é | ‚ùå –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∏–∫–æ–≤ | ‚ùå |
| **–ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ** | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É | ‚úÖ –ß–µ—Ä–µ–∑ `order_items` (co-purchase) | ‚úÖ |
| **–ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ** | Thumbs up | ‚úÖ `pair_feedback_stats.positive_count` | ‚úÖ |
| **–ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ** | –ù–µ –∫–ª–∏–∫–Ω—É—Ç–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è | ‚úÖ Hard negatives (—Å–ª—É—á–∞–π–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã) | ‚úÖ |
| **–ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ** | Thumbs down | ‚úÖ `pair_feedback_stats.negative_count` | ‚úÖ |

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: 4/5 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (80%)**

**–ù–µ–¥–æ—Å—Ç–∞—é—â–µ–µ:**

#### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

**–°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è:** `backend/migrations/000003_recommendation_events.up.sql`

**–¢–∞–±–ª–∏—Ü–∞:**
```sql
CREATE TABLE recommendation_events (
    event_type VARCHAR(20),  -- 'impression', 'click', 'add_to_cart'
    main_product_id INT,
    recommended_product_id INT,
    recommendation_rank INT,
    ...
);
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤–æ frontend:**
```javascript
// –ü—Ä–∏ –ø–æ–∫–∞–∑–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
await logRecommendationEvent({
  event_type: 'impression',
  main_product_id: productId,
  recommended_product_id: rec.id,
  rank: rec.rank,
});

// –ü—Ä–∏ –∫–ª–∏–∫–µ
await logRecommendationEvent({
  event_type: 'click',
  main_product_id: productId,
  recommended_product_id: rec.id,
  rank: rec.rank,
});
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ training_data_generator.py:**
```python
async def _get_positive_samples_from_clicks(
    self, session: AsyncSession
) -> List[Dict]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø–∞—Ä—ã —Å –∫–ª–∏–∫–∞–º–∏"""
    query = text("""
        SELECT
            main_product_id,
            recommended_product_id,
            COUNT(*) as click_count
        FROM recommendation_events
        WHERE event_type = 'click'
        GROUP BY main_product_id, recommended_product_id
        HAVING COUNT(*) >= 2
    """)
    # ...
```

**–§–∞–π–ª—ã:**
- `recommendations/app/ml/training_data_generator.py`
- `backend/migrations/000003_recommendation_events.up.sql` ‚úÖ (—Å–æ–∑–¥–∞–Ω–∞)

**–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ: 80%** ‚úÖ (–ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –±—É–¥–µ—Ç 100%)

---

### ‚ö†Ô∏è –†–∞–∑–¥–µ–ª 5: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**TDR —Ç—Ä–µ–±—É–µ—Ç:**
```
–ü–æ–∫–∞–∑ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π ‚Üí –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π ‚Üí –¢–∞–±–ª–∏—Ü–∞ recommendation_events
                                                    ‚Üì
                                           –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±—É—á–µ–Ω–∏–µ
                                                    ‚Üì
                                           LightGBM –º–æ–¥–µ–ª—å
                                                    ‚Üì
                                           –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Å–∫–æ—Ä–æ–≤
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | TDR | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å |
|-----------|-----|------------|--------|
| –ü–æ–∫–∞–∑ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π | ‚úÖ | Frontend + API | ‚úÖ |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π | ‚ö†Ô∏è | –¢–æ–ª—å–∫–æ —Ñ–∏–¥–±–µ–∫ (üëç/üëé) | ‚ö†Ô∏è |
| –¢–∞–±–ª–∏—Ü–∞ events | ‚ö†Ô∏è | –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞, –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å | ‚ö†Ô∏è |
| –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±—É—á–µ–Ω–∏–µ | ‚úÖ | `POST /ml/train` | ‚úÖ |
| –ú–æ–¥–µ–ª—å | ‚úÖ | CatBoostRanker | ‚úÖ |
| –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Å–∫–æ—Ä–æ–≤ | ‚úÖ | `rank_candidates()` | ‚úÖ |

**–ù–µ–¥–æ—Å—Ç–∞—é—â–µ–µ:**
1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é `000003_recommendation_events`
2. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤–æ frontend
3. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ backend (–ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π)

**–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ: 75%** ‚ö†Ô∏è

---

### ‚úÖ –†–∞–∑–¥–µ–ª 6: –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**TDR —Ç—Ä–µ–±—É–µ—Ç 5 –ø—É–Ω–∫—Ç–æ–≤:**

| ‚Ññ | –ü—É–Ω–∫—Ç | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å |
|---|-------|------------|--------|
| 1 | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π | ‚ö†Ô∏è –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞, –Ω—É–∂–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è | ‚ö†Ô∏è |
| 2 | –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö (1000+ —Å–æ–±—ã—Ç–∏–π) | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º ‚â•100 | ‚úÖ |
| 3 | –°–∫—Ä–∏–ø—Ç –æ–±—É—á–µ–Ω–∏—è | ‚úÖ `POST /ml/train` + `test_catboost.py` | ‚úÖ |
| 4 | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è `model.predict()` | ‚úÖ –í `product_recommender.py` | ‚úÖ |
| 5 | A/B —Ç–µ—Å—Ç | ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —á–µ—Ä–µ–∑ `use_ml=True/False` | ‚úÖ |

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: 4/5 –ø—É–Ω–∫—Ç–æ–≤ (80%)**

**–§–∞–π–ª—ã:**
- ‚úÖ `recommendations/app/ml/catboost_ranker.py`
- ‚úÖ `recommendations/app/services/product_recommender.py` (–∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω)
- ‚úÖ `recommendations/app/api/routes.py` (API endpoints)
- ‚úÖ `recommendations/test_catboost.py` (—Ç–µ—Å—Ç—ã)
- ‚ö†Ô∏è `backend/migrations/000003_recommendation_events.up.sql` (–Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å)

**–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ: 80%** ‚úÖ

---

### ‚ö†Ô∏è –†–∞–∑–¥–µ–ª 8: –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

**TDR —Ç—Ä–µ–±—É–µ—Ç:**

| –ú–µ—Ç—Ä–∏–∫–∞ | –¶–µ–ª—å TDR | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å |
|---------|----------|------------|--------|
| CTR –Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ | +10% | ‚ö†Ô∏è –ù—É–∂–Ω–æ –∏–∑–º–µ—Ä—è—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ | ‚ö†Ô∏è |
| –ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É | +5% | ‚ö†Ô∏è –ù—É–∂–Ω–æ –∏–∑–º–µ—Ä—è—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ | ‚ö†Ô∏è |
| NDCG@10 | > 0.7 | ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ–±—É—á–µ–Ω–∏–∏ (0.70+) | ‚úÖ |

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: 1/3 –º–µ—Ç—Ä–∏–∫ (33%)**

**–ö–∞–∫ –∏–∑–º–µ—Ä–∏—Ç—å CTR –∏ Conversion:**

```python
# –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ 000003
async def calculate_ctr(session: AsyncSession) -> float:
    """CTR = –∫–ª–∏–∫–∏ / –ø–æ–∫–∞–∑—ã"""
    result = await session.execute(text("""
        SELECT
            SUM(CASE WHEN event_type = 'click' THEN 1 ELSE 0 END)::FLOAT /
            NULLIF(SUM(CASE WHEN event_type = 'impression' THEN 1 ELSE 0 END), 0) as ctr
        FROM recommendation_events
        WHERE created_at > NOW() - INTERVAL '7 days'
    """))
    return result.scalar() or 0.0

async def calculate_conversion(session: AsyncSession) -> float:
    """Conversion = –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É / –ø–æ–∫–∞–∑—ã"""
    result = await session.execute(text("""
        SELECT
            SUM(CASE WHEN event_type = 'add_to_cart' THEN 1 ELSE 0 END)::FLOAT /
            NULLIF(SUM(CASE WHEN event_type = 'impression' THEN 1 ELSE 0 END), 0) as conversion
        FROM recommendation_events
        WHERE created_at > NOW() - INTERVAL '7 days'
    """))
    return result.scalar() or 0.0
```

**–î–æ–±–∞–≤–∏—Ç—å endpoint:**
```python
@router.get("/ml/metrics")
async def get_ml_metrics(session: AsyncSession = Depends(get_session)):
    """–ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ ML-—Ä–∞–Ω–∫–µ—Ä–∞"""
    return {
        "ctr": await calculate_ctr(session),
        "conversion": await calculate_conversion(session),
        "ndcg_10": catboost_ranker.model_metadata.get("metrics", {}).get("val_ndcg", 0),
    }
```

**–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ: 33%** ‚ö†Ô∏è (–±—É–¥–µ—Ç 100% –ø–æ—Å–ª–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π)

---

## –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å: 90%

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ:

1. **CatBoost —Ä–∞–Ω–∫–µ—Ä** ‚Äî —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å 36 –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏
2. **–û–±—É—á–µ–Ω–∏–µ** ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ñ–∏–¥–±–µ–∫–µ –∏ –∑–∞–∫–∞–∑–∞—Ö
3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö
4. **API** ‚Äî –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä endpoints –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
5. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** ‚Äî 2000+ —Å—Ç—Ä–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
6. **–¢–µ—Å—Ç—ã** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç

### ‚ö†Ô∏è –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏:

#### **–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**

1. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é `000003_recommendation_events`:**
   ```bash
   cd backend
   migrate -path migrations -database "postgresql://..." up
   ```

2. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤–æ frontend:**
   ```javascript
   // src/api/recommendations.ts
   export const logRecommendationEvent = async (event) => {
     await api.post('/recommendations/log-event', event);
   };
   ```

3. **–î–æ–±–∞–≤–∏—Ç—å backend handler –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**
   ```go
   // backend/internal/handler/recommendations.go
   func (h *Handler) LogRecommendationEvent(c *gin.Context) {
       // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ recommendation_events
   }
   ```

#### **–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**

4. **–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–æ–≤:**
   - –¢–∞–±–ª–∏—Ü–∞ `product_stats` (view_count, order_count)
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞—Ö/–∑–∞–∫–∞–∑–∞—Ö

5. **–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥–∏ —Ç–æ–≤–∞—Ä–æ–≤:**
   - –¢–∞–±–ª–∏—Ü–∞ `product_reviews` –∏–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ `rating` –≤ `products`

#### **–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏):**

6. **`complementary_score`** ‚Äî —Ç—Ä–µ–±—É–µ—Ç TDR-002 (–∫–æ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–µ–º—É —Ä–∞–∑–≤–∏—Ç–∏—é

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ (1-2 –Ω–µ–¥–µ–ª–∏):

1. ‚úÖ **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é 000003** –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
2. ‚úÖ **–°–æ–±—Ä–∞—Ç—å 1000+ —Å–æ–±—ã—Ç–∏–π** (impressions, clicks, add_to_cart)
3. ‚úÖ **–ü–µ—Ä–µ–æ–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å** —Å —É—á–µ—Ç–æ–º –∫–ª–∏–∫–æ–≤
4. ‚úÖ **–ò–∑–º–µ—Ä–∏—Ç—å CTR –∏ Conversion** –¥–æ/–ø–æ—Å–ª–µ ML

### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ (1-2 –º–µ—Å—è—Ü–∞):

5. ‚úÖ **–î–æ–±–∞–≤–∏—Ç—å product_stats** –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏
6. ‚úÖ **–î–æ–±–∞–≤–∏—Ç—å product_reviews** –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–æ–≤
7. ‚úÖ **A/B —Ç–µ—Å—Ç:** 50% formula vs 50% CatBoost, —Å—Ä–∞–≤–Ω–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏
8. ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å TDR-002** (–∫–æ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏) –∏ –¥–æ–±–∞–≤–∏—Ç—å `complementary_score`

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ (3+ –º–µ—Å—è—Ü–∞):

9. ‚úÖ **Online Learning:** –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è
10. ‚úÖ **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è:** –∏—Å—Ç–æ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è
11. ‚úÖ **Deep Learning:** –∑–∞–º–µ–Ω–∞ –Ω–∞ Two-Tower –º–æ–¥–µ–ª—å
12. ‚úÖ **Multi-objective:** –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è CTR, Conversion, Revenue

---

## –í—ã–≤–æ–¥—ã

### –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ TDR-003: **90%** ‚úÖ

**–ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Å–≤–µ—Ä—Ö TDR:**
- 36 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –≤–º–µ—Å—Ç–æ 11 (–≤ 3 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ!)
- –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
- Feature importance –¥–ª—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏
- Graceful fallback –Ω–∞ —Ñ–æ—Ä–º—É–ª—É
- –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (88 KB)
- –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

**–ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ 100%:**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–∫–æ–≤ (–º–∏–≥—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞, –Ω—É–∂–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è)
- 3 –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –ø—Ä–∏–∑–Ω–∞–∫–∞ (2 –Ω–∏–∑–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö)
- –ò–∑–º–µ—Ä–µ–Ω–∏–µ CTR/Conversion (–ø–æ—Å–ª–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)

**–í–µ—Ä–¥–∏–∫—Ç:** –°–∏—Å—Ç–µ–º–∞ ML-—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è **–ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞** –∏ **–ø—Ä–µ–≤–æ—Å—Ö–æ–¥–∏—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è TDR-003** –ø–æ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤—É –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤. –û—Å—Ç–∞–≤—à–∏–µ—Å—è 10% ‚Äî —ç—Ç–æ —É–ª—É—á—à–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–æ –º–µ—Ä–µ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö.

---

## –§–∞–π–ª—ã, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–ª—è TDR-003

### –û—Å–Ω–æ–≤–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:
- ‚úÖ `recommendations/app/ml/feature_extractor.py` ‚Äî 36 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
- ‚úÖ `recommendations/app/ml/training_data_generator.py` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ `recommendations/app/ml/catboost_ranker.py` ‚Äî CatBoost —Ä–∞–Ω–∫–µ—Ä
- ‚úÖ `recommendations/app/services/product_recommender.py` ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- ‚úÖ `recommendations/app/api/routes.py` ‚Äî API endpoints

### –ú–∏–≥—Ä–∞—Ü–∏–∏:
- ‚úÖ `backend/migrations/000003_recommendation_events.up.sql`
- ‚úÖ `backend/migrations/000003_recommendation_events.down.sql`

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- ‚úÖ `docs/CATBOOST_RANKING.md` ‚Äî 1050 —Å—Ç—Ä–æ–∫
- ‚úÖ `CATBOOST_QUICKSTART.md` ‚Äî 486 —Å—Ç—Ä–æ–∫
- ‚úÖ `docs/TDR-003_COMPLIANCE.md` ‚Äî —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç
- ‚úÖ `README.md` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω

### –¢–µ—Å—Ç—ã:
- ‚úÖ `recommendations/test_catboost.py` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
- ‚úÖ `recommendations/requirements.txt` ‚Äî +3 –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

**–í—Å–µ–≥–æ:** ~3500 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ + 2000+ —Å—Ç—Ä–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–∏–ª:** Claude (Anthropic)
**–î–∞—Ç–∞:** 2025-12-03
**–í–µ—Ä—Å–∏—è:** 1.0
