# Backend Checkpoint 2

**–î–∞—Ç–∞:** 01.12.2025

## –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ —Å –ø—Ä–æ—à–ª–æ–≥–æ —á–µ–∫–ø–æ–∏–Ω—Ç–∞

### 1. Redis ‚Äî –ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
**–°—Ç–∞—Ç—É—Å:** –≥–æ—Ç–æ–≤–æ

- [x] `internal/cache/client.go` ‚Äî Redis –∫–ª–∏–µ–Ω—Ç (go-redis/v9)
- [x] Redis –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω (–ø—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ‚Äî exit)
- [x] `REDIS_URL` –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–ö—ç—à –∫–∞—Ç–µ–≥–æ—Ä–∏–π:**
- [x] `internal/cache/category.go` ‚Äî –∫—ç—à –¥–µ—Ä–µ–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (TTL 1 —á–∞—Å)
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ CategoryHandler

### 2. –ö–æ—Ä–∑–∏–Ω–∞ ‚Äî –ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
**–°—Ç–∞—Ç—É—Å:** –≥–æ—Ç–æ–≤–æ

**Repository:**
- [x] `internal/repository/cart.go`:
  - GetByUserID, GetBySessionID
  - GetItemByID, FindItem
  - AddItem, UpdateQuantity, DeleteItem
  - ClearByUserID, ClearBySessionID
  - MergeGuestCart

**Service:**
- [x] `internal/service/cart.go`:
  - GetCart ‚Äî —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –∏ —Ä–∞—Å—á—ë—Ç–æ–º total
  - AddItem ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–æ–≤–∞—Ä–∞
  - UpdateQuantity ‚Äî —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤–ª–∞–¥–µ–ª—å—Ü–∞
  - RemoveItem ‚Äî —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤–ª–∞–¥–µ–ª—å—Ü–∞
  - ClearCart
  - MergeGuestCart ‚Äî –ø–µ—Ä–µ–Ω–æ—Å –∫–æ—Ä–∑–∏–Ω—ã –≥–æ—Å—Ç—è –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ

**Cache:**
- [x] `internal/cache/cart.go` ‚Äî –≥–∏–±—Ä–∏–¥–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ:
  - **–ì–æ—Å—Ç–∏ (session_id):** –∫–æ—Ä–∑–∏–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ Redis (TTL 30 –¥–Ω–µ–π)
  - **–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ (user_id):** –∫–æ—Ä–∑–∏–Ω–∞ –≤ PostgreSQL + –∫—ç—à –≤ Redis (TTL 1 —á–∞—Å)

**Handler:**
- [x] `internal/handler/cart.go`:
  - getCartOwner ‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ userID –∏–ª–∏ sessionID
  - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è session_id cookie –¥–ª—è –≥–æ—Å—Ç–µ–π (UUID, 30 –¥–Ω–µ–π)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–æ—É—Ç–µ—Ä–µ:**
- [x] –ö–æ—Ä–∑–∏–Ω–∞ —Ç–µ–ø–µ—Ä—å –ø—É–±–ª–∏—á–Ω–∞—è (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≥–æ—Å—Ç–µ–π)
- [x] CartCache –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ CartService

### 3. –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
**–°—Ç–∞—Ç—É—Å:** –≥–æ—Ç–æ–≤–æ

- [x] `ml/load_data.py` ‚Äî Python —Å–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ CSV:
  - –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (~3000 –∑–∞–ø–∏—Å–µ–π) —Å parent_id
  - –¢–æ–≤–∞—Ä—ã (~68000 –∑–∞–ø–∏—Å–µ–π)
  - –°–∫–∏–¥–∫–∏ (~64000 –∑–∞–ø–∏—Å–µ–π)

### 4. –£–ª—É—á—à–µ–Ω–∏—è
- [x] –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–∞–∫—Ç—É–∞–ª—å–Ω–∞—è)

```
backend/
‚îú‚îÄ‚îÄ cmd/server/main.go
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ cache/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.go           # Redis –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ category.go         # –ö—ç—à –¥–µ—Ä–µ–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cart.go             # –ì–æ—Å—Ç–µ–≤—ã–µ –∫–æ—Ä–∑–∏–Ω—ã + –∫—ç—à —é–∑–µ—Ä–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ config/config.go
‚îÇ   ‚îú‚îÄ‚îÄ database/postgres.go
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ category.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ product.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cart.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ order.go
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ promo.go
‚îÇ   ‚îú‚îÄ‚îÄ handler/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ router.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cart.go             # –†–µ–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ category.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ product.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ order.go            # –ó–∞–≥–ª—É—à–∫–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ recommendation.go   # –ó–∞–≥–ª—É—à–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth.go
‚îÇ   ‚îú‚îÄ‚îÄ model/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ category.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ product.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ promo.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cart.go
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ order.go
‚îÇ   ‚îú‚îÄ‚îÄ repository/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ category.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ product.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ promo.go
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cart.go             # –ù–æ–≤—ã–π
‚îÇ   ‚îî‚îÄ‚îÄ service/
‚îÇ       ‚îú‚îÄ‚îÄ auth.go
‚îÇ       ‚îî‚îÄ‚îÄ cart.go             # –ù–æ–≤—ã–π
‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îî‚îÄ‚îÄ 000001_init.up.sql
‚îú‚îÄ‚îÄ ml/
‚îÇ   ‚îî‚îÄ‚îÄ load_data.py
‚îú‚îÄ‚îÄ Dockerfile
‚îî‚îÄ‚îÄ go.mod
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (ENV)

```env
DATABASE_URL=postgres://user:pass@localhost:5432/dbname?sslmode=disable
REDIS_URL=redis://localhost:6379
JWT_SECRET=your-secret-key
PORT=8080
```

## API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### –ü—É–±–ª–∏—á–Ω—ã–µ
| Method | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| GET | /health | Health check |
| GET | /api/products | –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ |
| GET | /api/products/:id | –¢–æ–≤–∞—Ä –ø–æ ID |
| GET | /api/categories | –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π |
| GET | /api/categories/tree | –î–µ—Ä–µ–≤–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–∫—ç—à) |
| GET | /api/categories/:id | –ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø–æ ID |
| GET | /api/categories/:id/children | –î–æ—á–µ—Ä–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ |
| POST | /api/auth/register | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è |
| POST | /api/auth/login | –í—Ö–æ–¥ |
| GET | /api/cart | –ö–æ—Ä–∑–∏–Ω–∞ (–≥–æ—Å—Ç—å/—é–∑–µ—Ä) |
| POST | /api/cart/items | –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É |
| PUT | /api/cart/items/:id | –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ |
| DELETE | /api/cart/items/:id | –£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã |
| DELETE | /api/cart | –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É |
| GET | /api/recommendations/:product_id | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–∑–∞–≥–ª—É—à–∫–∞) |

### –ó–∞—â–∏—â—ë–Ω–Ω—ã–µ (—Ç—Ä–µ–±—É—é—Ç JWT)
| Method | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| GET | /api/auth/profile | –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| GET | /api/orders | –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ (–∑–∞–≥–ª—É—à–∫–∞) |
| POST | /api/orders | –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ (–∑–∞–≥–ª—É—à–∫–∞) |
| POST | /api/recommendations/feedback | –§–∏–¥–±–µ–∫ (–∑–∞–≥–ª—É—à–∫–∞) |

---

## –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å

### 1. –ó–∞–∫–∞–∑—ã ‚Äî —Ä–µ–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
**–°—Ç–∞—Ç—É—Å:** –∑–∞–≥–ª—É—à–∫–∏ –µ—Å—Ç—å

- [ ] `internal/repository/order.go` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞, –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞
- [ ] `internal/service/order.go` ‚Äî CreateOrder, GetOrders, GetOrderByID
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `internal/handler/order.go`

---

### 2. Merge –∫–æ—Ä–∑–∏–Ω—ã –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
**–°—Ç–∞—Ç—É—Å:** –ª–æ–≥–∏–∫–∞ –≥–æ—Ç–æ–≤–∞, –Ω—É–∂–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

- [ ] –í—ã–∑–≤–∞—Ç—å `cartService.MergeGuestCart(sessionID, userID)` –≤ AuthHandler.Login
- [ ] –ü–æ–ª—É—á–∏—Ç—å sessionID –∏–∑ cookie –≤ —Ö–µ–Ω–¥–ª–µ—Ä–µ –ª–æ–≥–∏–Ω–∞

---

### 3. Elasticsearch ‚Äî –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫
**–°—Ç–∞—Ç—É—Å:** –Ω–µ –Ω–∞—á–∞—Ç–æ

- [ ] `internal/search/client.go` ‚Äî ES –∫–ª–∏–µ–Ω—Ç
- [ ] Docker-compose: –¥–æ–±–∞–≤–∏—Ç—å Elasticsearch
- [ ] `GET /api/products/search?q=...`

---

### 4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ML —Å–µ—Ä–≤–∏—Å–æ–º
**–°—Ç–∞—Ç—É—Å:** –∑–∞–≥–ª—É—à–∫–∏ –µ—Å—Ç—å

- [ ] `internal/client/ml.go` ‚Äî HTTP –∫–ª–∏–µ–Ω—Ç –∫ Python ML —Å–µ—Ä–≤–∏—Å—É
- [ ] `internal/service/recommendation.go`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `internal/handler/recommendation.go`

---

### 5. –°–∫–∏–¥–∫–∏/–ê–∫—Ü–∏–∏ ‚Äî —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
**–°—Ç–∞—Ç—É—Å:** —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –µ—Å—Ç—å, —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –Ω–µ—Ç

- [ ] `GET /api/promos` ‚Äî –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫—Ü–∏–∏
- [ ] `GET /api/products/:id/promo` ‚Äî —Å–∫–∏–¥–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä

---

### 6. –ü—Ä–æ—Å–º–æ—Ç—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤ (–¥–ª—è ML)
**–°—Ç–∞—Ç—É—Å:** —Ç–∞–±–ª–∏—Ü–∞ –µ—Å—Ç—å, –ª–æ–≥–∏–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞

- [ ] `internal/repository/product_view.go`
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–∏ `GET /api/products/:id`

---

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ó–∞–¥–∞—á–∞ |
|-----------|--------|
| üî¥ –í—ã—Å–æ–∫–∏–π | –ó–∞–∫–∞–∑—ã (—Ä–µ–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞) |
| üî¥ –í—ã—Å–æ–∫–∏–π | Merge –∫–æ—Ä–∑–∏–Ω—ã –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ |
| üü° –°—Ä–µ–¥–Ω–∏–π | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ML —Å–µ—Ä–≤–∏—Å–æ–º |
| üü° –°—Ä–µ–¥–Ω–∏–π | Elasticsearch –ø–æ–∏—Å–∫ |
| üü° –°—Ä–µ–¥–Ω–∏–π | –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã —Å–∫–∏–¥–æ–∫ |
| üü¢ –ù–∏–∑–∫–∏–π | –ü—Ä–æ—Å–º–æ—Ç—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤ |
| üü¢ –ù–∏–∑–∫–∏–π | –í–∞–ª–∏–¥–∞—Ü–∏—è |

## –¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã

```bash
# –ö–æ—Ä–∑–∏–Ω–∞ –≥–æ—Å—Ç—è
curl -c cookies.txt http://localhost:8080/api/cart

# –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
curl -b cookies.txt -X POST http://localhost:8080/api/cart/items \
  -H "Content-Type: application/json" \
  -d '{"product_id": 1, "quantity": 2}'

# –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
curl -b cookies.txt -X PUT http://localhost:8080/api/cart/items/1 \
  -H "Content-Type: application/json" \
  -d '{"quantity": 5}'

# –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä
curl -b cookies.txt -X DELETE http://localhost:8080/api/cart/items/1

# –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
curl -b cookies.txt -X DELETE http://localhost:8080/api/cart
```
