# ML –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (Checkpoint 3)

## –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

–ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞—é—â–∞—è —Å–∏—Å—Ç–µ–º–∞ ML-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —Å –¥–≤—É–º—è —Ç–∏–ø–∞–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π, —Å–±–æ—Ä–æ–º —Ñ–∏–¥–±–µ–∫–∞ –∏ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–º –æ–±—É—á–µ–Ω–∏–µ–º.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Frontend   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Go Backend ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  ML Service      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Ollama  ‚îÇ
‚îÇ  (React)    ‚îÇ     ‚îÇ  (Gin)      ‚îÇ     ‚îÇ  (FastAPI)       ‚îÇ     ‚îÇ         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ                    ‚îÇ
                           ‚ñº                    ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ PostgreSQL  ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ product_embeddings‚îÇ
                    ‚îÇ             ‚îÇ     ‚îÇ pair_feedback     ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ scenario_feedback ‚îÇ
                                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –ü–æ—Ä—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|------------|------|------------|
| Frontend | React + Vite | 3000 | UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è |
| Backend | Go + Gin | 8080 | API Gateway, –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∫ ML |
| ML Service | FastAPI | 8000 | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, —Ñ–∏–¥–±–µ–∫ |
| Ollama | ollama/ollama | 11434 | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ |
| PostgreSQL | postgres:16 | 5432 | –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö |

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ ML-—Å–µ—Ä–≤–∏—Å–∞

```
recommendations/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ main.py              # FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å lifespan
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (PostgreSQL, Ollama)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ embeddings.py    # OllamaEmbeddings –∫–ª–∞—Å—Å
‚îÇ   ‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.py        # SQLAlchemy –º–æ–¥–µ–ª–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ queries.py       # –ó–∞–ø—Ä–æ—Å—ã –∫ –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ scenarios.py     # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ product_recommender.py   # –¢–∏–ø 1: —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ç–æ–≤–∞—Ä–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ scenario_recommender.py  # –¢–∏–ø 2: —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é
‚îÇ   ‚îî‚îÄ‚îÄ api/
‚îÇ       ‚îú‚îÄ‚îÄ routes.py        # –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã FastAPI
‚îÇ       ‚îî‚îÄ‚îÄ schemas.py       # Pydantic –º–æ–¥–µ–ª–∏
‚îú‚îÄ‚îÄ generate_embeddings.py   # –°–∫—Ä–∏–ø—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ Dockerfile
```

---

## –¢–∏–ø 1: –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ç–æ–≤–∞—Ä–∞

### API Endpoint

```
GET /api/recommendations/{product_id}?limit=20
```

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞ —Ç–æ–≤–∞—Ä–∞** –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `product_embeddings`
2. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è** –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–∞
3. **–ü–æ–∏—Å–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤** –∏–∑ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å—Ü–µ–Ω–∞—Ä–∏—è (–∏—Å–∫–ª—é—á–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—é –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞)
4. **ML-—Å–∫–æ—Ä–∏–Ω–≥** –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:

```python
score = 0.5  # –±–∞–∑–æ–≤—ã–π

# –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è –±–ª–∏–∑–æ—Å—Ç—å (cosine similarity)
similarity = cosine_similarity(main_embedding, candidate_embedding)
score += similarity * 0.3  # –¥–æ +0.3

# –§–∏–¥–±–µ–∫ –¥–ª—è –ø–∞—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤
pair_stats = get_pair_feedback(main_id, candidate_id)
if pair_stats.total > 0:
    approval = (pair_stats.positive + 1) / (pair_stats.total + 2)  # –ë–∞–π–µ—Å–æ–≤—Å–∫–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
    score += (approval - 0.5) * 0.4  # –æ—Ç -0.2 –¥–æ +0.2

# –§–∏–¥–±–µ–∫ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏
scenario_stats = get_scenario_feedback(scenario_id, candidate_id)
if scenario_stats.total > 0:
    approval = (scenario_stats.positive + 1) / (scenario_stats.total + 2)
    score += (approval - 0.5) * 0.2  # –æ—Ç -0.1 –¥–æ +0.1

# –ë—É—Å—Ç –∑–∞ —Å–∫–∏–¥–∫—É
if candidate.discount_price:
    discount_pct = (candidate.price - candidate.discount_price) / candidate.price
    score += discount_pct * 0.1  # –¥–æ +0.1
```

5. **–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞** –ø–æ score, –≤–æ–∑–≤—Ä–∞—Ç —Ç–æ–ø-20

### –û—Ç–≤–µ—Ç API

```json
{
  "product_id": 9011800178,
  "product_name": "–®—Ç—É–∫–∞—Ç—É—Ä–∫–∞ KNAUF –†–æ—Ç–±–∞–Ω–¥ 30–∫–≥",
  "detected_scenario": {"id": "walls", "name": "–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Å—Ç–µ–Ω"},
  "recommendations": [
    {
      "product": {
        "id": 1001319777,
        "name": "–≥—Ä—É–Ω—Ç –∞–∫—Ä–∏–ª–æ–≤—ã–π CERESIT CT17 Pro",
        "price": 890,
        "picture": "...",
        "discount_price": null
      },
      "score": 0.94,
      "rank": 1,
      "reason": "–ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ì—Ä—É–Ω—Ç–æ–≤–∫–∏",
      "match_reasons": [
        {"type": "category", "text": "–ì—Ä—É–Ω—Ç–æ–≤–∫–∏"},
        {"type": "feedback", "text": "94% –æ–¥–æ–±—Ä–∏–ª–∏"},
        {"type": "semantic", "text": "–°—Ö–æ–∂–µ—Å—Ç—å: 0.87"}
      ]
    }
  ],
  "total_count": 20
}
```

---

## –¢–∏–ø 2: –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é

### –°—Ü–µ–Ω–∞—Ä–∏–∏ White Box

–û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã 3 —Å—Ü–µ–Ω–∞—Ä–∏—è —Ä–µ–º–æ–Ω—Ç–∞:

#### 1. –ú–æ–Ω—Ç–∞–∂ –Ω–∞–ª–∏–≤–Ω–æ–≥–æ –ø–æ–ª–∞ (`floor`)

| –ì—Ä—É–ø–ø–∞ | –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
|--------|-----------|-------------|
| –û—Å–Ω–æ–≤–∞ | –Ω–∞–ª–∏–≤–Ω–æ–π, —Ä–æ–≤–Ω–∏—Ç–µ–ª—å, —Å—Ç—è–∂–∫–∞ | –î–∞ |
| –ì—Ä—É–Ω—Ç—ã | –≥—Ä—É–Ω—Ç, –≥—Ä—É–Ω—Ç–æ–≤–∫–∞ | –î–∞ |
| –Å–º–∫–æ—Å—Ç–∏ | –≤–µ–¥—Ä–æ, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —ë–º–∫–æ—Å—Ç—å | –î–∞ |
| –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (–≤–∞–ª–∏–∫) | –≤–∞–ª–∏–∫ –∏–≥–æ–ª—å—á–∞—Ç—ã–π | –î–∞ |
| –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (–º–∏–∫—Å–µ—Ä) | –Ω–∞—Å–∞–¥–∫–∞, –º–∏–∫—Å–µ—Ä | –î–∞ |
| –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (—É—Ä–æ–≤–µ–Ω—å) | —É—Ä–æ–≤–µ–Ω—å | –ù–µ—Ç |

#### 2. –ú–æ–Ω—Ç–∞–∂ –ø–µ—Ä–µ–≥–æ—Ä–æ–¥–æ–∫ (`partitions`)

| –ì—Ä—É–ø–ø–∞ | –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
|--------|-----------|-------------|
| –û—Å–Ω–æ–≤–∞ | –≥–∞–∑–æ–±–ª–æ–∫, –≥–∏–ø—Å–æ–∫–∞—Ä—Ç–æ–Ω, –ø–∞–∑–æ–≥—Ä–µ–±–Ω–µ–≤–∞—è | –î–∞ |
| –ö–ª–µ–π | –∫–ª–µ–π –¥–ª—è –±–ª–æ–∫–æ–≤, –∫–ª–µ–π –¥–ª—è –≥–∫–ª | –î–∞ |
| –ì—Ä—É–Ω—Ç—ã | –≥—Ä—É–Ω—Ç | –î–∞ |
| –®–ø–∞—Ç–ª—ë–≤–∫–∞ | —à–ø–∞—Ç–ª—ë–≤–∫–∞, —à–ø–∞–∫–ª—ë–≤–∫–∞ | –î–∞ |
| –Å–º–∫–æ—Å—Ç–∏ | –≤–µ–¥—Ä–æ, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä | –î–∞ |
| –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç | –Ω–∞—Å–∞–¥–∫–∞, –º–∏–∫—Å–µ—Ä | –î–∞ |

#### 3. –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Å—Ç–µ–Ω (`walls`)

| –ì—Ä—É–ø–ø–∞ | –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
|--------|-----------|-------------|
| –û—Å–Ω–æ–≤–∞ | —à—Ç—É–∫–∞—Ç—É—Ä–∫–∞ | –î–∞ |
| –ì—Ä—É–Ω—Ç—ã | –≥—Ä—É–Ω—Ç, –±–µ—Ç–æ–Ω–æ–∫–æ–Ω—Ç–∞–∫—Ç | –î–∞ |
| –®–ø–∞—Ç–ª—ë–≤–∫–∞ | —à–ø–∞—Ç–ª—ë–≤–∫–∞, —à–ø–∞–∫–ª—ë–≤–∫–∞ | –î–∞ |
| –Å–º–∫–æ—Å—Ç–∏ | –≤–µ–¥—Ä–æ, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä | –î–∞ |
| –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç | –ø—Ä–∞–≤–∏–ª–æ, —à–ø–∞—Ç–µ–ª—å | –î–∞ |
| –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (–º–∏–∫—Å–µ—Ä) | –Ω–∞—Å–∞–¥–∫–∞ | –î–∞ |
| –ê—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ | —Å–µ—Ç–∫–∞, —Å–µ—Ä–ø—è–Ω–∫–∞ | –ù–µ—Ç |

### API Endpoints

```
GET /api/scenarios                                    # –°–ø–∏—Å–æ–∫ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
GET /api/scenarios/{id}                               # –î–µ—Ç–∞–ª–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è
GET /api/scenarios/{id}/recommendations?cart_product_ids=1,2,3
GET /api/recommendations/scenario/auto?cart_product_ids=1,2,3
```

### –ê–ª–≥–æ—Ä–∏—Ç–º –∞–≤—Ç–æ–≤—ã–±–æ—Ä–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è

```python
def select_scenario(cart_product_ids):
    # –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è —Å—á–∏—Ç–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
    for scenario in scenarios:
        completed = 0
        for group in scenario.groups:
            # –ï—Å—Ç—å –ª–∏ –≤ –∫–æ—Ä–∑–∏–Ω–µ —Ç–æ–≤–∞—Ä –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≥—Ä—É–ø–ø—ã?
            if any(product_in_group(p, group) for p in cart_products):
                completed += 1

        scenario.progress = completed / len(scenario.required_groups)

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–π —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
    return max(scenarios, key=lambda s: s.progress)
```

### –û—Ç–≤–µ—Ç API —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é

```json
{
  "scenario": {"id": "floor", "name": "–ú–æ–Ω—Ç–∞–∂ –Ω–∞–ª–∏–≤–Ω–æ–≥–æ –ø–æ–ª–∞"},
  "progress": {
    "completed": 2,
    "total": 5,
    "percentage": 40
  },
  "recommendations": [
    {
      "group_name": "–Å–º–∫–æ—Å—Ç–∏",
      "is_required": true,
      "products": [
        {
          "id": 1001479759,
          "name": "–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π 90–ª",
          "price": 320,
          "score": 0.87,
          "reason": "–ü–æ–ø—É–ª—è—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
        }
      ]
    }
  ],
  "completed_groups": [
    {
      "group_name": "–û—Å–Ω–æ–≤–∞",
      "cart_products": [{"id": 123, "name": "–†–æ–≤–Ω–∏—Ç–µ–ª—å PLITONIT"}]
    }
  ],
  "all_scenarios": [
    {"id": "floor", "name": "–ú–æ–Ω—Ç–∞–∂ –Ω–∞–ª–∏–≤–Ω–æ–≥–æ –ø–æ–ª–∞"},
    {"id": "walls", "name": "–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Å—Ç–µ–Ω"},
    {"id": "partitions", "name": "–ú–æ–Ω—Ç–∞–∂ –ø–µ—Ä–µ–≥–æ—Ä–æ–¥–æ–∫"}
  ]
}
```

---

## –°–∏—Å—Ç–µ–º–∞ —Ñ–∏–¥–±–µ–∫–∞

### –¢–∞–±–ª–∏—Ü—ã –ë–î

```sql
-- –§–∏–¥–±–µ–∫ –¥–ª—è –ø–∞—Ä —Ç–æ–≤–∞—Ä–æ–≤ (–¢–∏–ø 1)
CREATE TABLE pair_feedback (
    id SERIAL PRIMARY KEY,
    main_product_id INT NOT NULL,
    recommended_product_id INT NOT NULL,
    feedback_type VARCHAR(20) NOT NULL,  -- 'positive' / 'negative'
    created_at TIMESTAMP DEFAULT NOW()
);

-- –§–∏–¥–±–µ–∫ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏—è (–¢–∏–ø 2)
CREATE TABLE scenario_feedback (
    id SERIAL PRIMARY KEY,
    scenario_id VARCHAR(50) NOT NULL,
    group_name VARCHAR(100),
    product_id INT NOT NULL,
    feedback_type VARCHAR(20) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### API –¥–ª—è —Ñ–∏–¥–±–µ–∫–∞

```
POST /api/feedback
{
  "main_product_id": 123,           // –¥–ª—è –¢–∏–ø–∞ 1
  "recommended_product_id": 456,
  "feedback": "positive",           // –∏–ª–∏ "negative"
  "context": "product_page",        // –∏–ª–∏ "scenario"
  "scenario_id": "floor",           // –¥–ª—è –¢–∏–ø–∞ 2
  "group_name": "–ì—Ä—É–Ω—Ç—ã"            // –¥–ª—è –¢–∏–ø–∞ 2
}
```

### –í–ª–∏—è–Ω–∏–µ —Ñ–∏–¥–±–µ–∫–∞ –Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–±–∞–π–µ—Å–æ–≤—Å–∫–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ**:

```
approval_rate = (positive_count + 1) / (total_count + 2)
```

| –§–∏–¥–±–µ–∫ | approval_rate | –í–ª–∏—è–Ω–∏–µ –Ω–∞ score |
|--------|---------------|------------------|
| 0üëç 0üëé | 0.50 | 0 (–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ) |
| 5üëç 0üëé | 0.86 | +0.14 |
| 10üëç 2üëé | 0.79 | +0.12 |
| 2üëç 8üëé | 0.25 | -0.10 |

---

## –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤

### –ú–æ–¥–µ–ª—å

- **Ollama** —Å –º–æ–¥–µ–ª—å—é `nomic-embed-text`
- –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –≤–µ–∫—Ç–æ—Ä–∞: **768**
- –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ~100-500ms –Ω–∞ —Ç–æ–≤–∞—Ä

### –§–æ—Ä–º–∞—Ç —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —ç–º–±–µ–¥–¥–∏–Ω–≥–∞

```python
text = f"{product.name}. –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category_name}. {description}"
```

### –°–∫—Ä–∏–ø—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

```bash
docker exec -it spbtechrun-recommendations-1 python generate_embeddings.py
```

–°–∫—Ä–∏–ø—Ç:
1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ PostgreSQL
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Ollama API
4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–µ–∫—Ç–æ—Ä –≤ —Ç–∞–±–ª–∏—Ü—É `product_embeddings`
5. –ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–≤–æ–¥–∏—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å

### –¢–∞–±–ª–∏—Ü–∞ product_embeddings

```sql
CREATE TABLE product_embeddings (
    product_id INT PRIMARY KEY,
    embedding FLOAT8[] NOT NULL,  -- –º–∞—Å—Å–∏–≤ –∏–∑ 768 —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–≤–∞—Ä–∞ (`ProductPage.tsx`)

- –ë–ª–æ–∫ "–°–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã" —Å 20 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
- **Score visualization** ‚Äî –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Å –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º (94%)
- **Match reasons** ‚Äî —Ü–≤–µ—Ç–Ω—ã–µ —Ç–µ–≥–∏:
  - –°–∏–Ω–∏–π ‚Äî –∫–∞—Ç–µ–≥–æ—Ä–∏—è
  - –ó–µ–ª—ë–Ω—ã–π ‚Äî —Ñ–∏–¥–±–µ–∫
  - –§–∏–æ–ª–µ—Ç–æ–≤—ã–π ‚Äî —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å
- –ö–Ω–æ–ø–∫–∏ üëç/üëé –¥–ª—è —Ñ–∏–¥–±–µ–∫–∞
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–∫–∏–¥–æ–∫ (–±–µ–π–¥–∂ + –∑–∞—á—ë—Ä–∫–Ω—É—Ç–∞—è —Ü–µ–Ω–∞)

### –ö–∞—Ä—É—Å–µ–ª—å –Ω–∞ –≥–ª–∞–≤–Ω–æ–π (`ScenarioCarousel.tsx`)

- –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —Å requestAnimationFrame
- –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª (—Ç–æ–≤–∞—Ä—ã –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è 3x)
- –ü–∞—É–∑–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –º—ã—à–∏
- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è
- –ö–Ω–æ–ø–∫–∏ "–í –∫–æ—Ä–∑–∏–Ω—É" –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
- –°—Å—ã–ª–∫–∞ –Ω–∞ –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è (`ScenarioDetailPage.tsx`)

- Breadcrumbs –Ω–∞–≤–∏–≥–∞—Ü–∏—è
- –ü—Ä–æ–≥—Ä–µ—Å—Å —Å—Ü–µ–Ω–∞—Ä–∏—è (X –∏–∑ Y –≥—Ä—É–ø–ø)
- –ì—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
- –°—Ç–∞—Ç—É—Å—ã: ‚úì –ì–æ—Ç–æ–≤–æ / –ù—É–∂–Ω–æ
- –§–∏–¥–±–µ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø

### –°–ø–∏—Å–æ–∫ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (`ScenariosPage.tsx`)

- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å –∏–∫–æ–Ω–∫–∞–º–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–ø–ø –≤ –∫–∞–∂–¥–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏

---

## Go Backend ‚Äî Proxy handlers

### –§–∞–π–ª: `backend/internal/handler/recommendation.go`

```go
type RecommendationHandler struct {
    mlURL  string
    client *http.Client
}

func (h *RecommendationHandler) GetRecommendations(c *gin.Context) {
    productID := c.Param("product_id")
    limit := c.DefaultQuery("limit", "20")
    url := fmt.Sprintf("%s/recommendations/%s?limit=%s", h.mlURL, productID, limit)
    h.proxyRequest(c, "GET", url, nil)
}

func (h *RecommendationHandler) GetAutoScenarioRecommendations(c *gin.Context) {
    cartProductIDs := c.Query("cart_product_ids")
    url := fmt.Sprintf("%s/recommendations/scenario/auto?cart_product_ids=%s", h.mlURL, cartProductIDs)
    h.proxyRequest(c, "GET", url, nil)
}
```

### –ú–∞—Ä—à—Ä—É—Ç—ã (`router.go`)

```go
api.GET("/recommendations/:product_id", recommendationHandler.GetRecommendations)
api.GET("/recommendations/scenario/auto", recommendationHandler.GetAutoScenarioRecommendations)
api.GET("/scenarios", recommendationHandler.GetScenarios)
api.GET("/scenarios/:scenario_id", recommendationHandler.GetScenario)
api.GET("/scenarios/:scenario_id/recommendations", recommendationHandler.GetScenarioRecommendations)
api.POST("/feedback", recommendationHandler.PostFeedback)
```

---

## Docker Compose

### –°–µ—Ä–≤–∏—Å Ollama

```yaml
ollama:
  image: ollama/ollama:latest
  ports:
    - "11434:11434"
  volumes:
    - ollama_data:/root/.ollama
  healthcheck:
    test: ollama list | grep -q nomic-embed-text || ollama pull nomic-embed-text
    interval: 30s
    timeout: 300s
    start_period: 60s
```

### –°–µ—Ä–≤–∏—Å Recommendations

```yaml
recommendations:
  build: ./recommendations
  ports:
    - "8000:8000"
  environment:
    - POSTGRES_HOST=postgres
    - OLLAMA_URL=http://ollama:11434
    - OLLAMA_MODEL=nomic-embed-text
  depends_on:
    postgres:
      condition: service_healthy
    ollama:
      condition: service_healthy
```

---

## –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—Å–∫–∞

### 1. –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

```bash
docker-compose up -d
```

–ü–æ—Ä—è–¥–æ–∫ —Å—Ç–∞—Ä—Ç–∞:
1. postgres ‚Üí healthcheck
2. redis ‚Üí healthcheck
3. elasticsearch ‚Üí healthcheck
4. ollama ‚Üí —Å–∫–∞—á–∏–≤–∞–µ—Ç –º–æ–¥–µ–ª—å nomic-embed-text (~274MB)
5. recommendations ‚Üí –∂–¥—ë—Ç postgres + ollama
6. backend ‚Üí –∂–¥—ë—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
7. frontend

### 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ (–æ–¥–∏–Ω —Ä–∞–∑)

```bash
docker exec -it spbtechrun-recommendations-1 python generate_embeddings.py
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–¥–µ–ª—å Ollama
docker exec spbtechrun-ollama-1 ollama list

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏
docker exec spbtechrun-postgres-1 psql -U postgres -d spbtechrun \
  -c "SELECT COUNT(*) FROM product_embeddings"

# –¢–µ—Å—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
curl http://localhost:8080/api/recommendations/1

# –¢–µ—Å—Ç —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
curl http://localhost:8080/api/scenarios
```

---

## –•–æ–ª–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç vs –û–±—É—á–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

### –î–µ–Ω—å 1 (–±–µ–∑ —Ñ–∏–¥–±–µ–∫–∞)

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Å–Ω–æ–≤–∞–Ω—ã —Ç–æ–ª—å–∫–æ –Ω–∞ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞—Ö:

```
–ì—Ä—É–Ω—Ç CERESIT: similarity=0.82, feedback=0, score=0.82
–ì—Ä—É–Ω—Ç KNAUF:   similarity=0.77, feedback=0, score=0.77
```

### –ü–æ—Å–ª–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è —Ñ–∏–¥–±–µ–∫–∞

```
–ì—Ä—É–Ω—Ç KNAUF:   similarity=0.77, feedback=45üëç/3üëé, score=0.98 ‚¨ÜÔ∏è
–ì—Ä—É–Ω—Ç CERESIT: similarity=0.82, feedback=30üëç/10üëé, score=0.92
```

KNAUF –ø–æ–¥–Ω—è–ª—Å—è –≤—ã—à–µ –±–ª–∞–≥–æ–¥–∞—Ä—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–º—É —Ñ–∏–¥–±–µ–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

---

## –ú–µ—Ç—Ä–∏–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### API –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

```
GET /api/ml/stats
```

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏–¥–±–µ–∫–∞ (–ø–æ —Ç–∏–ø–∞–º)
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—è–º

---

## –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞

### ML Service

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `recommendations/app/main.py` | FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ |
| `recommendations/app/core/config.py` | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ |
| `recommendations/app/core/embeddings.py` | –ö–ª–∞—Å—Å OllamaEmbeddings |
| `recommendations/app/db/models.py` | SQLAlchemy –º–æ–¥–µ–ª–∏ |
| `recommendations/app/db/queries.py` | –ó–∞–ø—Ä–æ—Å—ã –∫ –ë–î |
| `recommendations/app/services/scenarios.py` | –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ |
| `recommendations/app/services/product_recommender.py` | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¢–∏–ø 1 |
| `recommendations/app/services/scenario_recommender.py` | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¢–∏–ø 2 |
| `recommendations/app/api/routes.py` | –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã |
| `recommendations/app/api/schemas.py` | Pydantic –º–æ–¥–µ–ª–∏ |
| `recommendations/generate_embeddings.py` | –°–∫—Ä–∏–ø—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ |

### Frontend

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `frontend/src/pages/ProductPage.tsx` | –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–≤–∞—Ä–∞ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ |
| `frontend/src/pages/ScenariosPage.tsx` | –°–ø–∏—Å–æ–∫ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ |
| `frontend/src/pages/ScenarioDetailPage.tsx` | –î–µ—Ç–∞–ª–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è |
| `frontend/src/components/recommendations/ScenarioCarousel.tsx` | –ö–∞—Ä—É—Å–µ–ª—å –Ω–∞ –≥–ª–∞–≤–Ω–æ–π |
| `frontend/src/api/recommendations.ts` | API –∫–ª–∏–µ–Ω—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π |
| `frontend/src/api/scenarios.ts` | API –∫–ª–∏–µ–Ω—Ç —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ |
| `frontend/src/hooks/useProducts.ts` | React Query —Ö—É–∫–∏ |

### Backend

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `backend/internal/handler/recommendation.go` | Proxy handlers |
| `backend/internal/handler/router.go` | –ú–∞—Ä—à—Ä—É—Ç—ã |
